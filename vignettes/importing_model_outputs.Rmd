---
title: "Importing and extracting data"
author: "Benjamin Guiastrennec"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Importing model outputs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
library(xpose)
options(width = 100)

xpdb <- xpdb_ex_pk

knitr::opts_chunk$set(fig.dpi = 96,
                      fig.align = 'center', 
                      fig.height = 4, 
                      fig.width = 4,
                      out.width = '75%',
                      comment = '')
```

## Import
### Import model output
To import the model output files (e.g. NONMEM tables). The function `xpose_data()` collects all model output files and table and organizes them into an R object commonly called `xpdb` for xpose data base. Note that xpose makes use of the [readr](http://readr.tidyverse.org) package to rapidly import big dataset into R.

``` r
xpdb <- xpose_data(runno = '001')
```

### Imported files
#### NONMEM runs
To make full use of the functionality offered by `xpose` the following NONMEM output files should be available:

- `.lst/.out/.res`: used to collect information on the run (`template_titles`) as well as the output table names. Alternatively a model file (`.mod/.ctl`) can be used but some of the information in `template_titles` may not be available.
- `.ext`: used to collect final parameter estimates and residual standard error (RSE)
- `.phi`: used for the random effects and iOFV
- `.cov`: used for the covariance matrix
- `.cor`: used for the correlation matrix
- `.grd`: used for the estimation gradients
- `.shk`: used to compute random effect shrinkage `template_titles`
- output and simulation tables: for the actual data

When importing the files, xpose will return messages to the console and inform of any issue encountered during the import.

```r
xpdb <- xpose_data(runno = '001')

Looking for nonmem output tables
Reading: sdtab001, catab001, cotab001, patab001 [$prob no.1]

Looking for nonmem output files
Reading: run001.cor, run001.cov, run001.ext, run001.grd, run001.phi
```

These messages can be silenced with the option `quiet = TRUE`.


#### Others NLME tools
Coming with future releases...


### Structure of the `xpdb` object
A typical `xpdb` object contains 7 levels namely:

- `code`: the parsed model code
- `summary`: contains key information regarding the model. All the information contained in the summary can be used as part of the `template_titles`.
- `data`: contains all output and simulation tables as well as the column indexing
- `files`: contains all output files
- `gg_theme`: an attached ggplot2 theme
- `xp_theme`: an attached xpose theme
- `options`: attached global options

### Glimpse at the xpdb
The files attached to an xpdb object can be displayed to the console simply by writing its name to the console or by using the `print()` function. Any of these files can be extracted from the xpdb using one of the functions listed below.

```{r demo print xpose_data}
xpdb # or print(xpdb)
```

## Extract 
### Extract code
The `get_code()` function can be used to extract the parsed model code from the xpdb. This code was used to create the summary and find table names and can be used to get additional information regarding the run. If the argument `problem` is specified a subset of the code can be returned based on `$PROBLEM`. 

*Note that general code warnings and PsN outputs appended are listed as problem 0.*

```{r demo get_code}
code <- get_code(xpdb)
code
```

### Extract data
The `get_data()` function can be used to extract the imported table files. Tables can be extracted by `table` name or by `problem`. In the latter a single dataset containing all aggregated tables is returned. If more than one `table` name or `problem` number is provided a named list is returned. 

*Note when providing a table name it is not garanteed that the table will be identical to its file e.g. the order of the columns may have been changed and tables with `FIRSTONLY` will no longer be deduplicated.*

```{r demo get_data}
data <- get_data(xpdb, table = 'cotab001')
data
```

### Extract file
The `get_file()` function can be used to extract the imported output files. Files can be extracted by `file` name, by `problem` and/or `subprob`. If more than one `file` name, `problem` or subproblem number is provided a named list is returned. 

```{r demo get_file}
file <- get_file(xpdb, file = 'run001.ext')
file
```

### Extract summary
The `get_summary()` function can be used to extract the generated run summary from which the `template_titles`. If the argument `problem` is specified a subset of the summary can be returned based on `$PROBLEM`. 

*Note that general summary information are listed as problem 0.*

```{r demo get_summary}
run_sum <- get_summary(xpdb, problem = 0)
run_sum
```
